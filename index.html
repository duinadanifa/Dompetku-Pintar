<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Catatan Keuangan Harian</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#f5f7f7;
    --card:#ffffff;
    --accent:#2e7d32;
    --danger:#d32f2f;
    --muted:#6b7280;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:Inter,Segoe UI,Arial;padding:20px;color:#122}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  h1{margin:0;font-size:20px}
  .container{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 8px 20px rgba(2,6,23,0.06)}
  label{display:block;font-weight:600;margin-top:8px;margin-bottom:6px;color:var(--muted)}
  input[type="number"], input[type="text"], select, input[type="date"]{
    width:100%;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.08)
  }
  .row{display:flex;gap:12px}
  .row > *{flex:1}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:10px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left}
  th{background:var(--accent);color:white;border-bottom:2px solid rgba(0,0,0,0.08)}
  .actions{display:flex;gap:8px;margin-top:10px}
  button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--muted)}
  button.danger{background:var(--danger)}
  #result{margin-top:12px;font-weight:700}
  #warning{margin-top:6px;color:var(--danger);font-weight:700}
  .date-wrap{min-width:170px}
  /* Chart smaller and centered */
  .chart-wrap{max-width:360px;margin:18px auto 0 auto}
  canvas{width:100% !important;height:220px !important}
  @media (max-width:820px){ .row{flex-direction:column} .date-wrap{width:100%} }
</style>
</head>
<body>

<header>
  <div><h1>ðŸ“˜ Catatan Keuangan Harian</h1><div style="color:var(--muted);font-size:13px">Simpan otomatis di browser</div></div>
  <div class="date-wrap"><input type="date" id="dateInput" /></div>
</header>

<div class="container">
  <label for="saldoAwal">Saldo Awal (Rp):</label>
  <input type="number" id="saldoAwal" placeholder="Masukkan saldo awal..." />

  <label for="limit">Batas Pengeluaran Maksimal (Rp):</label>
  <input type="number" id="limit" placeholder="Contoh: 50000" />

  <table id="financeTable" aria-label="Tabel transaksi">
    <thead>
      <tr>
        <th style="width:45%">Keterangan</th>
        <th style="width:20%">Nominal (Rp)</th>
        <th style="width:20%">Jenis</th>
        <th style="width:15%">Aksi</th>
      </tr>
    </thead>
    <tbody id="financeBody"></tbody>
  </table>

  <div class="actions">
    <button id="addRowBtn">+ Tambah Baris</button>
    <button id="calcBtn">Hitung</button>
    <button id="resetBtn" class="ghost">Reset Data</button>
  </div>

  <div id="result">ðŸ’° Saldo Akhir: Rp 0</div>
  <div id="warning"></div>

  <div class="chart-wrap">
    <canvas id="chart"></canvas>
  </div>
</div>

<script>
/*
  Behavior:
  - layout preserved: date top-right, saldo awal, limit, table (Keterangan/Nominal/Jenis/Aksi)
  - data auto-save to localStorage on changes, add, delete, calculate
  - load saved data on startup
*/

const STORAGE_KEY = 'catatan_keuangan_v2';

const el = id => document.getElementById(id);
const financeBody = el('financeBody');
const saldoEl = el('saldoAwal');
const limitEl = el('limit');
const dateEl = el('dateInput');
const resultEl = el('result');
const warnEl = el('warning');
const chartCanvas = el('chart');
let doughnutChart = null;

// --- Initialization: load saved or create default one row ---
function init(){
  const saved = loadData();
  if(saved){
    // fill inputs
    saldoEl.value = saved.saldoAwal ?? '';
    limitEl.value = saved.limit ?? '';
    dateEl.value = saved.tanggal ?? '';
    // populate rows
    financeBody.innerHTML = '';
    if(Array.isArray(saved.transaksi) && saved.transaksi.length){
      saved.transaksi.forEach(t => addRow(t.keterangan, t.nominal, t.jenis, false));
    } else {
      addRow('', '', 'Pengeluaran', false);
    }
    // show last calculation if existed
    if(saved.saldoAkhir !== undefined) {
      resultEl.textContent = `ðŸ’° Saldo Akhir: Rp ${numberFormat(saved.saldoAkhir)}`;
      if(saved.pengeluaran !== undefined) updateChart(saved.pemasukan||0, saved.pengeluaran||0);
    } else {
      updateChart(0,0);
    }
  } else {
    // default
    saldoEl.value = '';
    limitEl.value = '';
    dateEl.value = '';
    financeBody.innerHTML = '';
    addRow('','', 'Pengeluaran', false);
    updateChart(0,0);
  }
  attachAutoSaveHandlers();
}

function numberFormat(n){ return Number(n||0).toLocaleString('id-ID'); }

// --- Add a row: optionally provide values; manual indicates whether to save & focus ---
function addRow(keterangan = '', nominal = '', jenis = 'Pengeluaran', manual = true){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" class="inp-ket" value="${escapeHtml(keterangan)}" placeholder="Contoh: Jajan"/></td>
    <td style="text-align:right"><input type="number" class="inp-nom" value="${nominal}" placeholder="0" /></td>
    <td>
      <select class="inp-jenis">
        <option value="Pemasukan"${jenis==='Pemasukan' ? ' selected':''}>Pemasukan</option>
        <option value="Pengeluaran"${jenis==='Pengeluaran' ? ' selected':''}>Pengeluaran</option>
      </select>
    </td>
    <td style="text-align:center"><button class="delBtn" title="Hapus baris" style="background:#d32f2f;color:#fff;padding:6px 8px;border-radius:6px;border:0;cursor:pointer">Hapus</button></td>`;
  financeBody.appendChild(tr);

  // attach delete handler
  tr.querySelector('.delBtn').addEventListener('click', ()=>{ tr.remove(); saveData(); });

  // attach change handlers for auto-save
  tr.querySelectorAll('input, select').forEach(inp=>{
    inp.addEventListener('change', ()=> { saveData(); });
    inp.addEventListener('input', ()=> { /* don't spam saving on typing; but keep for UX */ });
  });

  if(manual){
    saveData();
    tr.querySelector('.inp-ket').focus();
  }
}

// escape minimal
function escapeHtml(s){ return String(s||'').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// calculate totals and display results; also save
function calculate(){
  const saldoAwal = Number(saldoEl.value) || 0;
  const limit = Number(limitEl.value) || 0;
  const rows = Array.from(financeBody.querySelectorAll('tr'));
  let pemasukan = 0, pengeluaran = 0;
  const transaksi = [];

  rows.forEach(r=>{
    const ket = r.querySelector('.inp-ket').value.trim();
    const nom = Number(r.querySelector('.inp-nom').value) || 0;
    const jenis = r.querySelector('.inp-jenis').value;
    transaksi.push({ keterangan: ket, nominal: nom, jenis });
    if(jenis === 'Pemasukan') pemasukan += nom; else pengeluaran += nom;
  });

  const saldoAkhir = saldoAwal + pemasukan - pengeluaran;
  resultEl.textContent = `ðŸ’° Saldo Akhir: Rp ${numberFormat(saldoAkhir)}`;
  warnEl.textContent = (limit > 0 && pengeluaran > limit) ? 'âš ï¸ Pengeluaran melebihi batas!' : '';

  // chart
  updateChart(pemasukan, pengeluaran);

  // save snapshot
  const data = {
    saldoAwal, limit, tanggal: dateEl.value || '', transaksi,
    saldoAkhir, pemasukan, pengeluaran
  };
  saveData(data); // prefer explicit
}

// update Chart.js donut
function updateChart(pemasukan, pengeluaran){
  if(doughnutChart) doughnutChart.destroy();
  doughnutChart = new Chart(chartCanvas, {
    type:'doughnut',
    data:{
      labels:['Pemasukan','Pengeluaran'],
      datasets:[{ data:[pemasukan||0, pengeluaran||0], backgroundColor:['#4CAF50','#F44336'] }]
    },
    options:{ plugins:{ legend:{ position:'bottom' } }, maintainAspectRatio:false }
  });
}

// --- Storage helpers ---
function loadData(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}
function saveData(explicitData){
  // if caller provides explicit snapshot, use it; else build from DOM
  let data = explicitData || buildDataFromDom();
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){}
}
function buildDataFromDom(){
  const saldoAwal = Number(saldoEl.value) || 0;
  const limit = Number(limitEl.value) || 0;
  const tanggal = dateEl.value || '';
  const rows = Array.from(financeBody.querySelectorAll('tr'));
  let pemasukan = 0, pengeluaran = 0;
  const transaksi = [];
  rows.forEach(r=>{
    const ket = r.querySelector('.inp-ket').value.trim();
    const nom = Number(r.querySelector('.inp-nom').value) || 0;
    const jenis = r.querySelector('.inp-jenis').value;
    transaksi.push({ keterangan: ket, nominal: nom, jenis });
    if(jenis === 'Pemasukan') pemasukan += nom; else pengeluaran += nom;
  });
  const saldoAkhir = saldoAwal + pemasukan - pengeluaran;
  return { saldoAwal, limit, tanggal, transaksi, saldoAkhir, pemasukan, pengeluaran };
}

// attach auto-save when inputs change
function attachAutoSaveHandlers(){
  [saldoEl, limitEl, dateEl].forEach(inp=>{
    inp.addEventListener('change', ()=> { saveData(); });
    inp.addEventListener('input', ()=> { /* no-op */ });
  });
}

// reset storage & UI
function resetAll(){
  if(!confirm('Hapus semua data dan mulai dari awal?')) return;
  localStorage.removeItem(STORAGE_KEY);
  // clear UI and re-init
  financeBody.innerHTML = '';
  saldoEl.value = '';
  limitEl.value = '';
  dateEl.value = '';
  addRow('','', 'Pengeluaran', false);
  resultEl.textContent = `ðŸ’° Saldo Akhir: Rp 0`;
  warnEl.textContent = '';
  updateChart(0,0);
}

// --- wire buttons ---
el('addRowBtn').addEventListener('click', ()=> addRow('','', 'Pengeluaran', true));
el('calcBtn').addEventListener('click', calculate);
el('resetBtn').addEventListener('click', resetAll);

// init app
init();
</script>

</body>
</html>
